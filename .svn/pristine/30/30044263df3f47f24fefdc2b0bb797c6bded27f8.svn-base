package com.samhk.ynashk.service.impl;


import com.samhk.ynashk.controller.LoginAction;
import com.samhk.ynashk.mapper.LoginDao;
import com.samhk.ynashk.service.LoginBo;
import com.samhk.ynashk.util.Constants;
import com.samhk.ynashk.vo.FunctionVo;
import com.samhk.ynashk.vo.SystemUserVo;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;
import java.util.*;
@Slf4j
@Service(value = "loginImpl")
public class LoginImpl implements LoginBo {

    @Resource(name = "loginDao")
    public LoginDao loginDao;

    @Transactional(rollbackFor = Exception.class)
    @Override
    public LoginAction.LoginFlag login(SystemUserVo vo) {
        // session id
        vo.setTicket(Objects.requireNonNull(Constants.getSession()).getId());
        int i = loginDao.updateLoginTicket(vo);
        if (i < 1) {
            loginDao.insertLoginTicket(vo);
        }
        SystemUserVo userVo = loginDao.checkExistUser(vo);
        if (userVo == null) {
            // wrong password
            loginDao.setUserFailedCount(vo);
            return LoginAction.LoginFlag.PASSWORD_ERROR;
            //判断账户是停用
        } else if ("N".equals(userVo.getActiveInd())) {
            return LoginAction.LoginFlag.CHANGEPASSWORD;
            // locked
        } else if (userVo.getFailedCount() >= 5) {
            return LoginAction.LoginFlag.IS_LOCK;
        } else {
            loginDao.setUserFailedCount(userVo);
            // 获取系统当前时间
            Constants.getSession().setAttribute("loginTime", new Date());
            SystemUserVo systemUserVo = loginDao.getPrivileges(vo);
            Constants.getSession().setAttribute(Constants.LOGUSER, systemUserVo);
        }
        return LoginAction.LoginFlag.LOGIN_SUCCESS;
    }

    @Override
    public String userInterceptorCheck() {
        SystemUserVo sessionUserVo = (SystemUserVo) Objects.requireNonNull(Constants.getSession())
                .getAttribute(Constants.LOGUSER);
        SystemUserVo dbUserVo = loginDao.userInterceptorCheck(sessionUserVo);
        // 1 是否在其他地方登录 ，2 用户权限是否有修改，3 用户角色是否有修改，4用户信息是否有修改
        if (dbUserVo == null) {
            // 在该养老院已被删除
            return "error.login.userDelete";
        } else if (!sessionUserVo.getTicket().equals(dbUserVo.getTicket())) {
            // 用户在其他地方登录 请重新登录
            return "error.login.userLoginOtherAddress";
        } else if ((sessionUserVo.getLud().compareTo(dbUserVo
                .getLud())) != 0) {
            // 用户信息已经被修改
            return "error.login.userIsUpdate";
        }
        return null;
    }

    @Override
    public int logout(SystemUserVo systemUserVo) {
        return loginDao.logout(systemUserVo);
    }

    @Override
    public Map<String, Object> getPrivileges(SystemUserVo systemUserVo) {
        systemUserVo = loginDao.getPrivileges(systemUserVo);
        Map<String, Object> map = new HashMap<>();

        List<String> funcPrivileges = new ArrayList<>();
        if (systemUserVo != null && systemUserVo.getUserRoleVo().getFunctionList().size() > 0) {
            for (FunctionVo functionVo : systemUserVo.getUserRoleVo().getFunctionList()) {
                funcPrivileges.add(functionVo.getObjectName());
            }
            map.put("role", systemUserVo.getRoleCode());
            map.put("funcs", funcPrivileges);
        }
        return map;

    }
}
